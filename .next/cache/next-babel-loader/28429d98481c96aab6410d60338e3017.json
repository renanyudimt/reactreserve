{"ast":null,"code":"import mongoose from \"mongoose\";\nimport jwt from \"jsonwebtoken\";\nimport Cart from \"../../models/Cart\";\nimport connectDb from \"../../utils/connectDb\";\nconnectDb();\nconst {\n  ObjectId\n} = mongoose.Types;\nexport default (async (req, res) => {\n  switch (req.method) {\n    case \"GET\":\n      handleGetRequest(req, res);\n      break;\n\n    case \"PUT\":\n      handlePutRequest(req, res);\n      break;\n\n    case \"DELETE\":\n      handleDeleteRequest(req, res);\n      break;\n\n    default:\n      res.status(405).send(`Method ${req.method} not allowed`);\n      break;\n  }\n});\n\nasync function handleDeleteRequest(req, res) {\n  console.log(req.headers);\n\n  if (!(\"authorization\" in req.headers)) {\n    return res.status(401).json({\n      success: false,\n      msg: \"No authorization token\"\n    });\n  }\n\n  try {\n    const {\n      productId\n    } = req.query;\n    const {\n      userId\n    } = jwt.verify(req.headers.authorization, process.env.JWT_SECRET);\n    const filter = {\n      user: userId\n    };\n    const update = {\n      $pull: {\n        products: {\n          product: productId\n        }\n      }\n    };\n    const cart = await Cart.findOneAndUpdate(filter, update, {\n      new: true\n    }).populate({\n      path: \"products.product\",\n      model: \"Product\"\n    });\n    res.status(200).json({\n      success: true,\n      products: cart.products\n    });\n  } catch (error) {\n    console.log(\"error\", error);\n    res.status(403).send(\"Please, login again.\");\n  }\n}\n\nasync function handlePutRequest(req, res) {\n  if (!(\"authorization\" in req.headers)) {\n    return res.status(401).json({\n      success: false,\n      msg: \"No authorization token\"\n    });\n  }\n\n  try {\n    const {\n      quantity,\n      productId\n    } = req.body;\n    const {\n      userId\n    } = jwt.verify(req.headers.authorization, process.env.JWT_SECRET); //get user cart based on userId\n\n    const filer = {\n      user: userId\n    };\n    const cart = await Cart.findOne(filer); //check if product already exist\n\n    const productExist = cart.products.some(doc => ObjectId(productId).equals(doc.product)); //verifica se pelo menos 1 existe e retorna true\n    //if so, increment quantity,\n\n    if (productExist) {\n      const filter = {\n        _id: cart._id,\n        \"products.product\": productId\n      };\n      const update = {\n        $inc: {\n          \"products.$.quantity\": quantity\n        }\n      };\n      const response = await Cart.findOneAndUpdate(filter, update);\n\n      if (response) {\n        res.status(200).json({\n          success: true,\n          msg: \"Product updated successfully\"\n        });\n      } else {\n        res.status(403).send(\"Add product fail\");\n      } //if not, add new product with quantity\n\n    } else {\n      const newProduct = {\n        quantity,\n        product: productId\n      };\n      const filter = {\n        _id: cart._id\n      };\n      const update = {\n        $addToSet: {\n          products: newProduct\n        }\n      };\n      const response = await Cart.findOneAndUpdate(filter, update);\n\n      if (response) {\n        res.status(200).json({\n          success: true,\n          msg: \"Product updated successfully\"\n        });\n      } else {\n        res.status(403).send(\"Add product fail\");\n      }\n    }\n  } catch (error) {\n    console.log(\"error\", error);\n    res.status(403).send(\"Please, login again.\");\n  }\n}\n\nasync function handleGetRequest(req, res) {\n  if (!(\"authorization\" in req.headers)) {\n    return res.status(401).json({\n      success: false,\n      msg: \"No authorization token\"\n    });\n  }\n\n  try {\n    const {\n      userId\n    } = jwt.verify(req.headers.authorization, process.env.JWT_SECRET);\n    const cart = await Cart.findOne({\n      user: userId\n    }).populate({\n      path: \"products.product\",\n      model: \"Product\"\n    });\n\n    if (res.statusCode == 200) {\n      res.status(200).json({\n        success: true,\n        cart: cart.products\n      });\n    } else {\n      res.status(403).json({\n        success: false,\n        msg: \"Something went wrong.\"\n      });\n    }\n  } catch (error) {\n    console.log(\"error\", error);\n    res.status(403).json({\n      success: false,\n      msg: \"Please, login again.\"\n    });\n  }\n}","map":{"version":3,"sources":["/Users/renanyudi/Sites/estudos/react-app/react-next/pages/api/cart.js"],"names":["mongoose","jwt","Cart","connectDb","ObjectId","Types","req","res","method","handleGetRequest","handlePutRequest","handleDeleteRequest","status","send","console","log","headers","json","success","msg","productId","query","userId","verify","authorization","process","env","JWT_SECRET","filter","user","update","$pull","products","product","cart","findOneAndUpdate","new","populate","path","model","error","quantity","body","filer","findOne","productExist","some","doc","equals","_id","$inc","response","newProduct","$addToSet","statusCode"],"mappings":"AAAA,OAAOA,QAAP,MAAqB,UAArB;AACA,OAAOC,GAAP,MAAgB,cAAhB;AACA,OAAOC,IAAP,MAAiB,mBAAjB;AACA,OAAOC,SAAP,MAAsB,uBAAtB;AAEAA,SAAS;AACT,MAAM;AAAEC,EAAAA;AAAF,IAAeJ,QAAQ,CAACK,KAA9B;AAEA,gBAAe,OAAMC,GAAN,EAAWC,GAAX,KAAmB;AAEhC,UAAOD,GAAG,CAACE,MAAX;AACE,SAAK,KAAL;AACEC,MAAAA,gBAAgB,CAACH,GAAD,EAAMC,GAAN,CAAhB;AACA;;AAEF,SAAK,KAAL;AACEG,MAAAA,gBAAgB,CAACJ,GAAD,EAAMC,GAAN,CAAhB;AACA;;AAEF,SAAK,QAAL;AACEI,MAAAA,mBAAmB,CAACL,GAAD,EAAMC,GAAN,CAAnB;AACA;;AAEF;AACEA,MAAAA,GAAG,CAACK,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAsB,UAASP,GAAG,CAACE,MAAO,cAA1C;AACA;AAfJ;AAkBD,CApBD;;AAsBA,eAAeG,mBAAf,CAAmCL,GAAnC,EAAwCC,GAAxC,EAA6C;AAC3CO,EAAAA,OAAO,CAACC,GAAR,CAAYT,GAAG,CAACU,OAAhB;;AACA,MAAI,EAAE,mBAAmBV,GAAG,CAACU,OAAzB,CAAJ,EAAuC;AACrC,WAAOT,GAAG,CAACK,MAAJ,CAAW,GAAX,EAAgBK,IAAhB,CAAqB;AAAEC,MAAAA,OAAO,EAAE,KAAX;AAAkBC,MAAAA,GAAG,EAAE;AAAvB,KAArB,CAAP;AACD;;AAED,MAAI;AACF,UAAM;AAAEC,MAAAA;AAAF,QAAgBd,GAAG,CAACe,KAA1B;AACA,UAAM;AAAEC,MAAAA;AAAF,QAAarB,GAAG,CAACsB,MAAJ,CAAWjB,GAAG,CAACU,OAAJ,CAAYQ,aAAvB,EAAsCC,OAAO,CAACC,GAAR,CAAYC,UAAlD,CAAnB;AACA,UAAMC,MAAM,GAAG;AAAEC,MAAAA,IAAI,EAAEP;AAAR,KAAf;AACA,UAAMQ,MAAM,GAAG;AAAEC,MAAAA,KAAK,EAAE;AAAEC,QAAAA,QAAQ,EAAE;AAAEC,UAAAA,OAAO,EAAEb;AAAX;AAAZ;AAAT,KAAf;AACA,UAAMc,IAAI,GAAG,MAAMhC,IAAI,CAACiC,gBAAL,CAAsBP,MAAtB,EAA8BE,MAA9B,EAAsC;AAAEM,MAAAA,GAAG,EAAE;AAAP,KAAtC,EAAqDC,QAArD,CAA8D;AAC/EC,MAAAA,IAAI,EAAE,kBADyE;AAE/EC,MAAAA,KAAK,EAAE;AAFwE,KAA9D,CAAnB;AAKAhC,IAAAA,GAAG,CAACK,MAAJ,CAAW,GAAX,EAAgBK,IAAhB,CAAqB;AAAEC,MAAAA,OAAO,EAAE,IAAX;AAAiBc,MAAAA,QAAQ,EAAEE,IAAI,CAACF;AAAhC,KAArB;AAED,GAZD,CAYE,OAAMQ,KAAN,EAAa;AACb1B,IAAAA,OAAO,CAACC,GAAR,CAAY,OAAZ,EAAqByB,KAArB;AACAjC,IAAAA,GAAG,CAACK,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,sBAArB;AAED;AACF;;AAED,eAAeH,gBAAf,CAAgCJ,GAAhC,EAAqCC,GAArC,EAA0C;AACxC,MAAI,EAAE,mBAAmBD,GAAG,CAACU,OAAzB,CAAJ,EAAuC;AACrC,WAAOT,GAAG,CAACK,MAAJ,CAAW,GAAX,EAAgBK,IAAhB,CAAqB;AAAEC,MAAAA,OAAO,EAAE,KAAX;AAAkBC,MAAAA,GAAG,EAAE;AAAvB,KAArB,CAAP;AACD;;AAED,MAAI;AACF,UAAM;AAAEsB,MAAAA,QAAF;AAAYrB,MAAAA;AAAZ,QAA0Bd,GAAG,CAACoC,IAApC;AACA,UAAM;AAAEpB,MAAAA;AAAF,QAAarB,GAAG,CAACsB,MAAJ,CAAWjB,GAAG,CAACU,OAAJ,CAAYQ,aAAvB,EAAsCC,OAAO,CAACC,GAAR,CAAYC,UAAlD,CAAnB,CAFE,CAIF;;AACA,UAAMgB,KAAK,GAAG;AAAEd,MAAAA,IAAI,EAAEP;AAAR,KAAd;AACA,UAAMY,IAAI,GAAG,MAAMhC,IAAI,CAAC0C,OAAL,CAAaD,KAAb,CAAnB,CANE,CAOF;;AACA,UAAME,YAAY,GAAGX,IAAI,CAACF,QAAL,CAAcc,IAAd,CAAmBC,GAAG,IAAI3C,QAAQ,CAACgB,SAAD,CAAR,CAAoB4B,MAApB,CAA2BD,GAAG,CAACd,OAA/B,CAA1B,CAArB,CARE,CAQsF;AACxF;;AACA,QAAIY,YAAJ,EAAkB;AAChB,YAAMjB,MAAM,GAAG;AAAEqB,QAAAA,GAAG,EAAEf,IAAI,CAACe,GAAZ;AAAiB,4BAAoB7B;AAArC,OAAf;AACA,YAAMU,MAAM,GAAG;AAAEoB,QAAAA,IAAI,EAAE;AAAE,iCAAuBT;AAAzB;AAAR,OAAf;AACA,YAAMU,QAAQ,GAAG,MAAMjD,IAAI,CAACiC,gBAAL,CAAsBP,MAAtB,EAA6BE,MAA7B,CAAvB;;AAEA,UAAIqB,QAAJ,EAAc;AACZ5C,QAAAA,GAAG,CAACK,MAAJ,CAAW,GAAX,EAAgBK,IAAhB,CAAqB;AAAEC,UAAAA,OAAO,EAAE,IAAX;AAAiBC,UAAAA,GAAG,EAAE;AAAtB,SAArB;AACD,OAFD,MAEO;AACLZ,QAAAA,GAAG,CAACK,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,kBAArB;AACD,OATe,CAWlB;;AACC,KAZD,MAYO;AACL,YAAMuC,UAAU,GAAG;AAAEX,QAAAA,QAAF;AAAYR,QAAAA,OAAO,EAAEb;AAArB,OAAnB;AACA,YAAMQ,MAAM,GAAG;AAAEqB,QAAAA,GAAG,EAAEf,IAAI,CAACe;AAAZ,OAAf;AACA,YAAMnB,MAAM,GAAG;AAAEuB,QAAAA,SAAS,EAAE;AAAErB,UAAAA,QAAQ,EAAEoB;AAAZ;AAAb,OAAf;AACA,YAAMD,QAAQ,GAAG,MAAMjD,IAAI,CAACiC,gBAAL,CAAsBP,MAAtB,EAA6BE,MAA7B,CAAvB;;AAEA,UAAIqB,QAAJ,EAAc;AACZ5C,QAAAA,GAAG,CAACK,MAAJ,CAAW,GAAX,EAAgBK,IAAhB,CAAqB;AAAEC,UAAAA,OAAO,EAAE,IAAX;AAAiBC,UAAAA,GAAG,EAAE;AAAtB,SAArB;AACD,OAFD,MAEO;AACLZ,QAAAA,GAAG,CAACK,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,kBAArB;AACD;AACF;AACF,GAlCD,CAkCE,OAAM2B,KAAN,EAAa;AACb1B,IAAAA,OAAO,CAACC,GAAR,CAAY,OAAZ,EAAqByB,KAArB;AACAjC,IAAAA,GAAG,CAACK,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,sBAArB;AACD;AAEF;;AAED,eAAeJ,gBAAf,CAAgCH,GAAhC,EAAqCC,GAArC,EAA0C;AAExC,MAAI,EAAE,mBAAmBD,GAAG,CAACU,OAAzB,CAAJ,EAAuC;AACrC,WAAOT,GAAG,CAACK,MAAJ,CAAW,GAAX,EAAgBK,IAAhB,CAAqB;AAAEC,MAAAA,OAAO,EAAE,KAAX;AAAkBC,MAAAA,GAAG,EAAE;AAAvB,KAArB,CAAP;AACD;;AAED,MAAI;AACF,UAAM;AAAEG,MAAAA;AAAF,QAAarB,GAAG,CAACsB,MAAJ,CAAWjB,GAAG,CAACU,OAAJ,CAAYQ,aAAvB,EAAsCC,OAAO,CAACC,GAAR,CAAYC,UAAlD,CAAnB;AACA,UAAMO,IAAI,GAAG,MAAMhC,IAAI,CAAC0C,OAAL,CAAa;AAAEf,MAAAA,IAAI,EAAEP;AAAR,KAAb,EAA+Be,QAA/B,CAAwC;AACzDC,MAAAA,IAAI,EAAE,kBADmD;AAEzDC,MAAAA,KAAK,EAAE;AAFkD,KAAxC,CAAnB;;AAKA,QAAIhC,GAAG,CAAC+C,UAAJ,IAAkB,GAAtB,EAA2B;AACzB/C,MAAAA,GAAG,CAACK,MAAJ,CAAW,GAAX,EAAgBK,IAAhB,CAAqB;AAACC,QAAAA,OAAO,EAAE,IAAV;AAAgBgB,QAAAA,IAAI,EAAEA,IAAI,CAACF;AAA3B,OAArB;AACD,KAFD,MAEO;AACLzB,MAAAA,GAAG,CAACK,MAAJ,CAAW,GAAX,EAAgBK,IAAhB,CAAqB;AAAEC,QAAAA,OAAO,EAAE,KAAX;AAAkBC,QAAAA,GAAG,EAAE;AAAvB,OAArB;AACD;AAEF,GAbD,CAaE,OAAMqB,KAAN,EAAa;AACb1B,IAAAA,OAAO,CAACC,GAAR,CAAY,OAAZ,EAAqByB,KAArB;AACAjC,IAAAA,GAAG,CAACK,MAAJ,CAAW,GAAX,EAAgBK,IAAhB,CAAqB;AAAEC,MAAAA,OAAO,EAAE,KAAX;AAAkBC,MAAAA,GAAG,EAAE;AAAvB,KAArB;AACD;AACF","sourcesContent":["import mongoose from \"mongoose\";\nimport jwt from \"jsonwebtoken\";\nimport Cart from \"../../models/Cart\";\nimport connectDb from \"../../utils/connectDb\";\n\nconnectDb();\nconst { ObjectId } = mongoose.Types\n\nexport default async(req, res) => {\n\n  switch(req.method) {\n    case \"GET\":\n      handleGetRequest(req, res);\n      break;\n\n    case \"PUT\":\n      handlePutRequest(req, res);\n      break;\n\n    case \"DELETE\":\n      handleDeleteRequest(req, res)\n      break;\n\n    default:\n      res.status(405).send(`Method ${req.method} not allowed`)\n      break\n\n  }\n}\n\nasync function handleDeleteRequest(req, res) {\n  console.log(req.headers)\n  if (!(\"authorization\" in req.headers)) {\n    return res.status(401).json({ success: false, msg: \"No authorization token\" })\n  }\n\n  try {\n    const { productId } = req.query;\n    const { userId } = jwt.verify(req.headers.authorization, process.env.JWT_SECRET)\n    const filter = { user: userId }\n    const update = { $pull: { products: { product: productId }}}\n    const cart = await Cart.findOneAndUpdate(filter, update, { new: true }).populate({\n      path: \"products.product\",\n      model: \"Product\",\n    })\n\n    res.status(200).json({ success: true, products: cart.products})\n\n  } catch(error) {\n    console.log(\"error\", error)\n    res.status(403).send(\"Please, login again.\")\n\n  }\n}\n\nasync function handlePutRequest(req, res) {\n  if (!(\"authorization\" in req.headers)) {\n    return res.status(401).json({ success: false, msg: \"No authorization token\" })\n  }\n\n  try {\n    const { quantity, productId } = req.body;\n    const { userId } = jwt.verify(req.headers.authorization, process.env.JWT_SECRET)\n\n    //get user cart based on userId\n    const filer = { user: userId }\n    const cart = await Cart.findOne(filer)\n    //check if product already exist\n    const productExist = cart.products.some(doc => ObjectId(productId).equals(doc.product)) //verifica se pelo menos 1 existe e retorna true\n    //if so, increment quantity,\n    if (productExist) {\n      const filter = { _id: cart._id, \"products.product\": productId }\n      const update = { $inc: { \"products.$.quantity\": quantity }}\n      const response = await Cart.findOneAndUpdate(filter,update)\n\n      if (response) {\n        res.status(200).json({ success: true, msg: \"Product updated successfully\" })\n      } else {\n        res.status(403).send(\"Add product fail\")\n      }\n\n    //if not, add new product with quantity\n    } else {\n      const newProduct = { quantity, product: productId }\n      const filter = { _id: cart._id }\n      const update = { $addToSet: { products: newProduct }}\n      const response = await Cart.findOneAndUpdate(filter,update)\n\n      if (response) {\n        res.status(200).json({ success: true, msg: \"Product updated successfully\" })\n      } else {\n        res.status(403).send(\"Add product fail\")\n      }\n    }\n  } catch(error) {\n    console.log(\"error\", error)\n    res.status(403).send(\"Please, login again.\")\n  }\n\n}\n\nasync function handleGetRequest(req, res) {\n\n  if (!(\"authorization\" in req.headers)) {\n    return res.status(401).json({ success: false, msg: \"No authorization token\" })\n  }\n\n  try {\n    const { userId } = jwt.verify(req.headers.authorization, process.env.JWT_SECRET)\n    const cart = await Cart.findOne({ user: userId }).populate({\n      path: \"products.product\",\n      model: \"Product\"\n    })\n\n    if (res.statusCode == 200) {\n      res.status(200).json({success: true, cart: cart.products})\n    } else {\n      res.status(403).json({ success: false, msg: \"Something went wrong.\"})\n    }\n\n  } catch(error) {\n    console.log(\"error\", error)\n    res.status(403).json({ success: false, msg: \"Please, login again.\"})\n  }\n}"]},"metadata":{},"sourceType":"module"}